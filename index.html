<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI 에어컨 용량 계산기</title>
  <style>
    :root{
      --bg:#f4f6f9; --card:#ffffff; --text:#111827; --muted:#6b7280; --line:#e5e7eb;
      --shadow:0 10px 30px rgba(17,24,39,.07);
      --radius:16px; --radius-sm:12px;
      --accent:#3b82f6; --accent-soft:#eff6ff;
      --warn:#fff7ed; --warn-text:#9a3412;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;
      -webkit-font-smoothing:antialiased;line-height:1.45;}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    .header{background:linear-gradient(180deg,#ffffff 0%, #f8fafc 100%);
      border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);
      padding:18px 18px 16px;margin-bottom:14px;}
    .title{margin:0;font-size:22px;letter-spacing:-.2px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
      box-shadow:var(--shadow);padding:18px;margin-bottom:14px;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;align-items:start;}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:13px;color:#374151;font-weight:650}
    select,input{width:100%;padding:12px 12px;font-size:16px;border:1px solid var(--line);
      border-radius:var(--radius-sm);background:#fff;outline:none;transition:border-color .15s, box-shadow .15s;}
    select:focus,input:focus{border-color:rgba(59,130,246,.6);box-shadow:0 0 0 4px rgba(59,130,246,.12);}
    .help{font-size:12px;color:var(--muted)}
    .actions{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap}
    .btn{padding:12px 14px;border-radius:14px;border:0;cursor:pointer;font-size:16px;font-weight:750;
      color:#fff;background:linear-gradient(180deg,#111827 0%, #0b1220 100%);box-shadow:0 10px 25px rgba(17,24,39,.18);
      transition:transform .06s ease;}
    .btn:active{transform:translateY(1px)}
    .btnWide{width:100%}
    .btnGreen{background:linear-gradient(180deg,#16a34a 0%, #15803d 100%);}
    .resultCard{display:none;padding:18px}
    .badges{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:7px 10px;border-radius:999px;background:var(--accent-soft);
      color:#1d4ed8;font-weight:750;font-size:12.5px;border:1px solid rgba(59,130,246,.20);}
    .resultLine{display:flex;align-items:baseline;gap:10px;flex-wrap:wrap;margin:2px 0 6px;}
    .resultLabel{color:var(--muted);font-size:13px}
    .resultValue{font-size:28px;font-weight:850;letter-spacing:-.3px}
    .kwSub{font-size:13px;color:var(--muted);font-weight:650;margin-left:10px}
    .adjLine{margin:2px 0 0;color:var(--muted);font-size:13px;font-weight:650}
    .divider{height:1px;background:var(--line);margin:12px 0}
    .details{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kv{padding:12px;border:1px solid var(--line);border-radius:14px;background:#fafafa;}
    .k{color:var(--muted);font-size:12px;margin-bottom:4px}
    .v{font-size:14px;font-weight:750}
    .note{background:var(--warn);border:1px solid rgba(234,88,12,.20);color:var(--warn-text);border-radius:var(--radius);
      padding:12px 14px;font-size:13px;}
    .info{margin-top:10px;background:#f0f9ff;border:1px solid rgba(2,132,199,.22);color:#075985;border-radius:14px;
      padding:12px 14px;font-size:13px;font-weight:650;}
    .hidden{display:none !important;}
    @media (max-width:760px){.wrap{padding:16px}.grid{grid-template-columns:1fr}.resultValue{font-size:26px}.details{grid-template-columns:1fr}.btnWide{width:100%}}
  </style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <h1 class="title">AI 에어컨 용량 계산기</h1>
  </div>

  <div class="card">
    <div class="grid">
      <div class="field">
        <label for="sidoSelect">지역(시/도)</label>
        <select id="sidoSelect"></select>
        <div class="help">네이버 검색은 시/군/구 단위로 더 정확하게 검색합니다.</div>
      </div>

      <div class="field">
        <label for="sigunguSelect">지역(시/군/구)</label>
        <select id="sigunguSelect"></select>
        <div class="help">업체 검색 키워드에 이 값이 사용됩니다.</div>
      </div>

      <div class="field">
        <label for="groupSelect">공간 유형</label>
        <select id="groupSelect"></select>
      </div>

      <div class="field">
        <label for="conditionSelect">세부 조건</label>
        <select id="conditionSelect"></select>
        <div class="help" id="condHelp"></div>
      </div>

      <div class="field">
        <label for="areaInput">면적</label>
        <input id="areaInput" type="number" inputmode="decimal" placeholder="예: 33" min="0" step="0.1" />
        <div class="help">숫자만 입력하세요.</div>
      </div>

      <div class="field">
        <label for="unitSelect">단위</label>
        <select id="unitSelect">
          <option value="m2">m²</option>
          <option value="py">평</option>
        </select>
        <div class="help">1평 = 3.3058m²</div>
      </div>

      <div class="field hidden" id="coeffField">
        <label for="coeffSelect">부하계수(주택용)</label>
        <select id="coeffSelect"></select>
        <div class="help">주택/아파트/빌라는 “간편 추정”입니다.</div>
      </div>

      <div class="field hidden" id="ceilingField">
        <label for="ceilingSelect">천장 높이(주택용)</label>
        <select id="ceilingSelect">
          <option value="1.0">일반(2.2~2.4m)</option>
          <option value="1.1">높음(2.5~2.7m)</option>
          <option value="1.2">매우 높음(2.8m+)</option>
        </select>
        <div class="help">천장이 높으면 용량이 증가할 수 있어요.</div>
      </div>

      <div class="field">
        <label>기상청 데이터 반영</label>
        <div style="display:flex; gap:10px; align-items:center;">
          <input id="useKma" type="checkbox" style="width:18px; height:18px; margin:0;" />
          <div style="font-size:14px; font-weight:750; color:#111827;">최근 3년 최고기온으로 보정</div>
        </div>
        <div class="help">GitHub Pages 무료 버전: 권역별 기상청 참고값(정적)으로 보정합니다.</div>
      </div>

      <div class="help" id="tempHelp">기본값은 시/도 기본값(1.00)입니다. (기상청 조회 시 자동 대체)</div>
      </div>

      </div>
</div>

    <div class="actions">
      <button class="btn btnWide" id="calcBtn" type="button">용량 계산</button>
    </div>
  </div>

  <div class="card resultCard" id="outputCard">
    <div class="badges" id="badgeBox"></div>

    <div class="resultLine">
      <div class="resultLabel">추천 용량</div>
      <div class="resultValue" id="kwText">-</div>
    </div>
    <div class="adjLine" id="adjText"></div>

    <div class="divider"></div>

    <div class="details">
      <div class="kv">
        <div class="k">입력면적</div>
        <div class="v" id="inputAreaText">-</div>
      </div>
      <div class="kv">
        <div class="k" id="capLabel">1대 기준 공조면적</div>
        <div class="v" id="capAreaText">-</div>
      </div>
      <div class="kv">
        <div class="k">여유(참고)</div>
        <div class="v" id="marginText">-</div>
      </div>
      <div class="kv">
        <div class="k">최근 3년 최고기온(기상청)</div>
        <div class="v" id="tmaxText">-</div>
      </div>
    </div>

    <div id="extraBox"></div>
    <div class="divider"></div>
    <div class="actions">
      <button class="btn btnGreen btnWide" id="naverBtn" type="button">
        네이버 지도에서 지역 에어컨 업체 찾기
      </button>
    </div>

  </div>

  <div class="note">
    <b>주의</b> 실제 필요 용량은 단열/일사/유리면적/출입문/발열/환기 등에 따라 달라질 수 있습니다. 최종 선정은 현장 조건 반영이 필요합니다.
  </div>
</div>

<script>
/** ====== 지역 데이터 ====== */
const KOREA_ADMIN = {"서울특별시": ["종로구", "중구", "용산구", "성동구", "광진구", "동대문구", "중랑구", "성북구", "강북구", "도봉구", "노원구", "은평구", "서대문구", "마포구", "양천구", "강서구", "구로구", "금천구", "영등포구", "동작구", "관악구", "서초구", "강남구", "송파구", "강동구"], "부산광역시": ["중구", "서구", "동구", "영도구", "부산진구", "동래구", "남구", "북구", "해운대구", "사하구", "금정구", "강서구", "연제구", "수영구", "사상구", "기장군"], "대구광역시": ["중구", "동구", "서구", "남구", "북구", "수성구", "달서구", "달성군", "군위군"], "인천광역시": ["중구", "동구", "미추홀구", "연수구", "남동구", "부평구", "계양구", "서구", "강화군", "옹진군"], "광주광역시": ["동구", "서구", "남구", "북구", "광산구"], "대전광역시": ["동구", "중구", "서구", "유성구", "대덕구"], "울산광역시": ["중구", "남구", "동구", "북구", "울주군"], "세종특별자치시": ["세종시"], "경기도": ["수원시", "성남시", "의정부시", "안양시", "부천시", "광명시", "평택시", "동두천시", "안산시", "고양시", "과천시", "구리시", "남양주시", "오산시", "시흥시", "군포시", "의왕시", "하남시", "용인시", "파주시", "이천시", "안성시", "김포시", "화성시", "광주시", "양주시", "포천시", "여주시", "연천군", "가평군", "양평군"], "강원특별자치도": ["춘천시", "원주시", "강릉시", "동해시", "태백시", "속초시", "삼척시", "홍천군", "횡성군", "영월군", "평창군", "정선군", "철원군", "화천군", "양구군", "인제군", "고성군", "양양군"], "충청북도": ["청주시", "충주시", "제천시", "보은군", "옥천군", "영동군", "증평군", "진천군", "괴산군", "음성군", "단양군"], "충청남도": ["천안시", "공주시", "보령시", "아산시", "서산시", "논산시", "계룡시", "당진시", "금산군", "부여군", "서천군", "청양군", "홍성군", "예산군", "태안군"], "전북특별자치도": ["전주시", "군산시", "익산시", "정읍시", "남원시", "김제시", "완주군", "진안군", "무주군", "장수군", "임실군", "순창군", "고창군", "부안군"], "전라남도": ["목포시", "여수시", "순천시", "나주시", "광양시", "담양군", "곡성군", "구례군", "고흥군", "보성군", "화순군", "장흥군", "강진군", "해남군", "영암군", "무안군", "함평군", "영광군", "장성군", "완도군", "진도군", "신안군"], "경상북도": ["포항시", "경주시", "김천시", "안동시", "구미시", "영주시", "영천시", "상주시", "문경시", "경산시", "의성군", "청송군", "영양군", "영덕군", "청도군", "고령군", "성주군", "칠곡군", "예천군", "봉화군", "울진군", "울릉군"], "경상남도": ["창원시", "진주시", "통영시", "사천시", "김해시", "밀양시", "거제시", "양산시", "의령군", "함안군", "창녕군", "고성군", "남해군", "하동군", "산청군", "함양군", "거창군", "합천군"], "제주특별자치도": ["제주시", "서귀포시"]};
let tempFactor = 1.00;
function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
function setTempFactor(f){ tempFactor = clamp(Math.round(f*100)/100, 0.90, 1.25); }


// ====== (옵션) 기상청 최근 3년 최고기온 기반 보정 ======

// ★ 4개 권역 대표 관측소 매핑 (북부/중부/남부/제주)
// 북부: 서울(108) / 중부: 대전(133) / 남부: 대구(143) / 제주: 제주(184)
const STN_BY_REGION = {
  north: { name: "북부", stnId: 108 },   // 서울
  central: { name: "중부", stnId: 133 }, // 대전
  south: { name: "남부", stnId: 143 },   // 대구
  jeju: { name: "제주", stnId: 184 }     // 제주
};

function regionFromSido(sido){
  if (sido.includes("서울") || sido.includes("경기") || sido.includes("인천") ||
      sido.includes("강원") ) return "north";

  if (sido.includes("대전") || sido.includes("세종") ||
      sido.includes("충청")) return "central";

  if (sido.includes("부산") || sido.includes("대구") || sido.includes("울산") ||
      sido.includes("경상") || sido.includes("전라") || sido.includes("광주")) return "south";

  if (sido.includes("제주")) return "jeju";

  return "central"; // 기본값
}

// Netlify Functions 사용 권장: 
// - ServiceKey는 Netlify 환경변수(KMA_SERVICE_KEY)로 숨기세요.
// - 이 페이지는 함수가 없으면 자동으로 기본값(1.00)(SIDO_FACTOR)으로 fallback 합니다.

// ★ 전국 빠른 적용(B안): 시/도 -> 대표 관측소(stnId) 매핑을 "직접" 채워 넣는 방식
// 아래 STN_BY_SIDO 값을 채우면, 시/군/구 상관없이 해당 시/도 대표값으로 3년 최고기온을 조회합니다.
// (정확도는 관측소 선택에 따라 달라집니다)


function yyyymmdd(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}${m}${day}`;
}

function getTmax3yByRegion(regionKey){
  // 권역별(북부/중부/남부/제주) 최근 3년 최고기온 '참고값' (정적 내장)
  // ※ 완전 무료 호스팅(GitHub Pages)용: 실시간 API 호출 없이 동작하도록 구성
  const REGION_TMAX_3Y = {
    north: 38.8,
    central: 38.2,
    south: 39.5,
    jeju: 36.7
  };
  return REGION_TMAX_3Y[regionKey] ?? null;
}

// 보정계수 룰(예시): 33°C 기준, 1°C당 +2% (클램프 0.90~1.25)

// ====== KMA 조회 캐시 (10분) ======
let _kmaCache = { key: null, at: 0, tmax: null, factor: null };
let lastTmax3y = null;
const KMA_CACHE_MS = 10 * 60 * 1000;

function cacheKeyForKma(){
  const sido = (sidoSelect?.value || "").trim();
  return sido;
}

function factorFromTmax(t){
  const f = 1 + 0.02 * (t - 33);
  return clamp(Math.round(f*100)/100, 0.90, 1.25);
}

const useKma = document.getElementById("useKma");

async function refreshTempFactor(){
  const sido = (sidoSelect?.value || "").trim();
  const regionKey = regionFromSido(sido);
  const region = STN_BY_REGION[regionKey];

  if (!useKma?.checked){
    lastTmax3y = null;
    setTempFactor(1.00);
    return;
  }

  const t = getTmax3yByRegion(regionKey);
  if (t === null){
    lastTmax3y = null;
    setTempFactor(1.00);
    return;
  }

  const f = factorFromTmax(t);
  lastTmax3y = t;
  setTempFactor(f);

  // 결과가 떠 있으면 재계산
  if (outputCard.style.display === "block"){
    document.getElementById("calcBtn")?.click();
  }
}

/** ====== 상업공간 표 데이터 ====== */
const AC_TABLE = [
  { kw: 5.2,  ks_m2: 42.3, ks_py: 13, a: {
    office_ens_mid:44, office_ens_top:37, office_west_mid:35, office_west_top:31,
    restaurant_ens_noVent:23, restaurant_ens_vent:19, restaurant_west_noVent:17, restaurant_west_vent:14,
    retail_lowCrowd:33, retail_highCrowd:25,
    cafe_h_le_3m:17, cafe_h_3_45m:14,
    library_reading:36,
    church_hall:25, church_sanctuary:14
  }},
  { kw: 6.0,  ks_m2: 48.8, ks_py: 15, a: {
    office_ens_mid:51, office_ens_top:43, office_west_mid:40, office_west_top:35,
    restaurant_ens_noVent:26, restaurant_ens_vent:22, restaurant_west_noVent:20, restaurant_west_vent:16,
    retail_lowCrowd:38, retail_highCrowd:29,
    cafe_h_le_3m:20, cafe_h_3_45m:16,
    library_reading:42,
    church_hall:28, church_sanctuary:17
  }},
  { kw: 7.2,  ks_m2: 58.5, ks_py: 18, a: {
    office_ens_mid:61, office_ens_top:52, office_west_mid:48, office_west_top:42,
    restaurant_ens_noVent:31, restaurant_ens_vent:27, restaurant_west_noVent:24, restaurant_west_vent:19,
    retail_lowCrowd:46, retail_highCrowd:34,
    cafe_h_le_3m:24, cafe_h_3_45m:19,
    library_reading:50,
    church_hall:34, church_sanctuary:20
  }},
  { kw: 8.3,  ks_m2: 75.5, ks_py: 23, a: {
    office_ens_mid:71, office_ens_top:59, office_west_mid:55, office_west_top:49,
    restaurant_ens_noVent:36, restaurant_ens_vent:31, restaurant_west_noVent:27, restaurant_west_vent:22,
    retail_lowCrowd:53, retail_highCrowd:40,
    cafe_h_le_3m:27, cafe_h_3_45m:22,
    library_reading:58,
    church_hall:39, church_sanctuary:23
  }},
  { kw: 9.0,  ks_m2: 81.8, ks_py: 25, a: {
    office_ens_mid:77, office_ens_top:64, office_west_mid:60, office_west_top:53,
    restaurant_ens_noVent:39, restaurant_ens_vent:34, restaurant_west_noVent:30, restaurant_west_vent:23,
    retail_lowCrowd:57, retail_highCrowd:43,
    cafe_h_le_3m:30, cafe_h_3_45m:24,
    library_reading:63,
    church_hall:43, church_sanctuary:25
  }},
  { kw: 10.0, ks_m2: 90.9, ks_py: 28, a: {
    office_ens_mid:85, office_ens_top:72, office_west_mid:66, office_west_top:59,
    restaurant_ens_noVent:43, restaurant_ens_vent:37, restaurant_west_noVent:33, restaurant_west_vent:26,
    retail_lowCrowd:64, retail_highCrowd:48,
    cafe_h_le_3m:33, cafe_h_3_45m:27,
    library_reading:70,
    church_hall:47, church_sanctuary:28
  }},
  { kw: 11.0, ks_m2: 100.0, ks_py: 30, a: {
    office_ens_mid:94, office_ens_top:79, office_west_mid:73, office_west_top:65,
    restaurant_ens_noVent:48, restaurant_ens_vent:41, restaurant_west_noVent:36, restaurant_west_vent:29,
    retail_lowCrowd:70, retail_highCrowd:53,
    cafe_h_le_3m:36, cafe_h_3_45m:29,
    library_reading:77,
    church_hall:52, church_sanctuary:30
  }},
  { kw: 13.0, ks_m2: 118.2, ks_py: 36, a: {
    office_ens_mid:111, office_ens_top:93, office_west_mid:86, office_west_top:76,
    restaurant_ens_noVent:56, restaurant_ens_vent:49, restaurant_west_noVent:43, restaurant_west_vent:34,
    retail_lowCrowd:83, retail_highCrowd:62,
    cafe_h_le_3m:43, cafe_h_3_45m:35,
    library_reading:91,
    church_hall:61, church_sanctuary:36
  }},
  { kw: 14.5, ks_m2: 131.8, ks_py: 40, a: {
    office_ens_mid:124, office_ens_top:104, office_west_mid:96, office_west_top:85,
    restaurant_ens_noVent:63, restaurant_ens_vent:54, restaurant_west_noVent:48, restaurant_west_vent:38,
    retail_lowCrowd:92, retail_highCrowd:69,
    cafe_h_le_3m:48, cafe_h_3_45m:39,
    library_reading:101,
    church_hall:69, church_sanctuary:40
  }},
  { kw: 21.0, ks_m2: 190.9, ks_py: 58, a: {
    office_ens_mid:179, office_ens_top:150, office_west_mid:140, office_west_top:124,
    restaurant_ens_noVent:91, restaurant_ens_vent:79, restaurant_west_noVent:69, restaurant_west_vent:55,
    retail_lowCrowd:134, retail_highCrowd:100,
    cafe_h_le_3m:69, cafe_h_3_45m:56,
    library_reading:147,
    church_hall:99, church_sanctuary:58
  }},
  { kw: 23.0, ks_m2: 209.1, ks_py: 63, a: {
    office_ens_mid:196, office_ens_top:165, office_west_mid:153, office_west_top:135,
    restaurant_ens_noVent:100, restaurant_ens_vent:86, restaurant_west_noVent:76, restaurant_west_vent:60,
    retail_lowCrowd:147, retail_highCrowd:110,
    cafe_h_le_3m:75, cafe_h_3_45m:62,
    library_reading:161,
    church_hall:109, church_sanctuary:64
  }},
  { kw: 29.0, ks_m2: 263.6, ks_py: 80, a: {
    office_ens_mid:247, office_ens_top:208, office_west_mid:193, office_west_top:171,
    restaurant_ens_noVent:126, restaurant_ens_vent:108, restaurant_west_noVent:96, restaurant_west_vent:76,
    retail_lowCrowd:185, retail_highCrowd:139,
    cafe_h_le_3m:95, cafe_h_3_45m:78,
    library_reading:203,
    church_hall:137, church_sanctuary:80
  }},
  { kw: 30.0, ks_m2: 272.7, ks_py: 83, a: {
    office_ens_mid:256, office_ens_top:215, office_west_mid:199, office_west_top:177,
    restaurant_ens_noVent:130, restaurant_ens_vent:112, restaurant_west_noVent:99, restaurant_west_vent:78,
    retail_lowCrowd:191, retail_highCrowd:143,
    cafe_h_le_3m:98, cafe_h_3_45m:80,
    library_reading:210,
    church_hall:142, church_sanctuary:83
  }},
  { kw: 41.2, ks_m2: 374.5, ks_py: 113, a: {
    office_ens_mid:352, office_ens_top:295, office_west_mid:274, office_west_top:242,
    restaurant_ens_noVent:179, restaurant_ens_vent:154, restaurant_west_noVent:136, restaurant_west_vent:107,
    retail_lowCrowd:262, retail_highCrowd:197,
    cafe_h_le_3m:135, cafe_h_3_45m:110,
    library_reading:288,
    church_hall:195, church_sanctuary:114
  }},
  { kw: 58.2, ks_m2: 529.1, ks_py: 160, a: {
    office_ens_mid:497, office_ens_top:417, office_west_mid:387, office_west_top:342,
    restaurant_ens_noVent:253, restaurant_ens_vent:218, restaurant_west_noVent:193, restaurant_west_vent:152,
    retail_lowCrowd:371, retail_highCrowd:278,
    cafe_h_le_3m:191, cafe_h_3_45m:156,
    library_reading:407,
    church_hall:275, church_sanctuary:161
  }},
];

const RESIDENTIAL_COEFF = [
  { id:"res_low",  name:"단열 좋음 / 그늘 / 창 적음 (90 W/m²)", wpm2: 90 },
  { id:"res_mid",  name:"일반(보통) (110 W/m²)", wpm2: 110 },
  { id:"res_high", name:"서향/최상층/창 많음 (130 W/m²)", wpm2: 130 },
];

const GROUPS = [
  { id:"office", name:"사무실", type:"table", options:[
    { id:"office_ens_mid", name:"동/남/북향 · 중간층" },
    { id:"office_ens_top", name:"동/남/북향 · 최상층" },
    { id:"office_west_mid", name:"서향 · 중간층" },
    { id:"office_west_top", name:"서향 · 최상층" },
  ]},
  { id:"restaurant", name:"식당", type:"table", options:[
    { id:"restaurant_ens_noVent", name:"동/남/북향 · 환기 미사용" },
    { id:"restaurant_ens_vent",   name:"동/남/북향 · 환기 사용" },
    { id:"restaurant_west_noVent",name:"서향 · 환기 미사용" },
    { id:"restaurant_west_vent",  name:"서향 · 환기 사용" },
  ]},
  { id:"retail", name:"일반상점", type:"table", options:[
    { id:"retail_lowCrowd",  name:"사람출입 적음" },
    { id:"retail_highCrowd", name:"사람출입 많음" },
  ]},
  { id:"cafe", name:"카페/커피숍", type:"table", options:[
    { id:"cafe_h_le_3m", name:"천장높이 3m 이내" },
    { id:"cafe_h_3_45m", name:"천장높이 3~4.5m" },
  ]},
  { id:"library", name:"도서관", type:"table", options:[
    { id:"library_reading", name:"열람실" },
  ]},
  { id:"church", name:"교회", type:"table", options:[
    { id:"church_hall", name:"홀/로비" },
    { id:"church_sanctuary", name:"대예배당" },
  ]},
  { id:"residential", name:"주택/아파트/빌라", type:"residential", options:[
    { id:"residential_general", name:"거실/방(일반)" },
    { id:"residential_open", name:"거실+주방(개방형)" },
    { id:"residential_multi", name:"복층/계단 개방" },
  ], help:"주택은 단열/일사/층/창면적 변수로 오차가 큽니다. 부하계수 방식으로 간편 추정합니다."},
];

const M2_PER_PY = 3.3058;
function toM2(area, unit){
  const v = Number(area);
  if (!Number.isFinite(v) || v <= 0) return null;
  return unit === "py" ? v * M2_PER_PY : v;
}
function round1(x){ return Math.round(x*10)/10; }
function fmt(n){ return (Math.round(n*10)/10).toLocaleString("ko-KR"); }

function recommendTable(conditionId, areaM2){
  for (const row of AC_TABLE){
    const cap = row.a[conditionId];
    if (typeof cap === "number" && areaM2 <= cap) {
      return { mode:"table", match: row, capM2: cap };
    }
  }
  const maxRow = AC_TABLE[AC_TABLE.length - 1];
  const maxCap = maxRow.a[conditionId];
  const kwPerM2 = maxRow.kw / maxCap;
  const estKw = round1(areaM2 * kwPerM2);
  const estUnits = Math.ceil(areaM2 / maxCap);
  return { mode:"proportional", match: maxRow, capM2: maxCap, estKw, estUnits };
}

function recommendResidential(areaM2, coeffWpm2, ceilingFactor, optionId){
  const optionFactor =
    optionId === "residential_open" ? 1.10 :
    optionId === "residential_multi" ? 1.20 : 1.00;
  const watts = areaM2 * coeffWpm2 * ceilingFactor * optionFactor;
  const kw = round1(watts / 1000);
  return { mode:"residential", estKw: kw, coeffWpm2, ceilingFactor, optionFactor };
}

/** ====== UI ====== */
const sidoSelect = document.getElementById("sidoSelect");
const sigunguSelect = document.getElementById("sigunguSelect");
const tempText = document.getElementById("tempText");
const tempHelp = document.getElementById("tempHelp");

const groupSelect = document.getElementById("groupSelect");
const conditionSelect = document.getElementById("conditionSelect");
const unitSelect = document.getElementById("unitSelect");
const areaInput = document.getElementById("areaInput");
const condHelp = document.getElementById("condHelp");
const coeffField = document.getElementById("coeffField");
const coeffSelect = document.getElementById("coeffSelect");
const ceilingField = document.getElementById("ceilingField");
const ceilingSelect = document.getElementById("ceilingSelect");

const outputCard = document.getElementById("outputCard");
const badgeBox = document.getElementById("badgeBox");
const kwText = document.getElementById("kwText");
const adjText = document.getElementById("adjText");
const inputAreaText = document.getElementById("inputAreaText");
const capLabel = document.getElementById("capLabel");
const capAreaText = document.getElementById("capAreaText");
const marginText = document.getElementById("marginText");
const methodText = document.getElementById("methodText");
const extraBox = document.getElementById("extraBox");
const tmaxText = document.getElementById("tmaxText");

function fillSido(){
  const sidos = Object.keys(KOREA_ADMIN);
  sidoSelect.innerHTML = sidos.map(s => `<option value="${s}">${s}</option>`).join("");
  const defaultSido = sidos.includes("제주특별자치도") ? "제주특별자치도" : sidos[0];
  sidoSelect.value = defaultSido;
  fillSigungu(defaultSido);
}

function fillSigungu(sido){
  const list = KOREA_ADMIN[sido] || [];
  sigunguSelect.innerHTML = list.map(x => `<option value="${x}">${x}</option>`).join("");
  sigunguSelect.value = list[0] || "";
  refreshTempFactor();
}

function applySidoFactor(){
  const sido = sidoSelect.value;
  const f = SIDO_FACTOR[sido] ?? 1.00;
  setTempFactor(f);
  tempText?.textContent = `× ${tempFactor.toFixed(2)}`;
  tempHelp?.textContent = `시/도 기준 기본값(1.00): ${sido} (×${tempFactor.toFixed(2)})`;
  adjText.textContent = tempFactor === 1.0 ? "" : `지역 보정 적용: × ${tempFactor.toFixed(2)} (간편)`;
}

sidoSelect.addEventListener("change", ()=> fillSigungu(sidoSelect.value));
sigunguSelect.addEventListener("change", ()=>{ /* 검색 단위만 변경 */ });

function fillCoeffs(){
  coeffSelect.innerHTML = RESIDENTIAL_COEFF.map(c => `<option value="${c.wpm2}">${c.name}</option>`).join("");
  coeffSelect.value = String(RESIDENTIAL_COEFF[1].wpm2);
}

function fillGroups(){
  groupSelect.innerHTML = GROUPS.map(g => `<option value="${g.id}">${g.name}</option>`).join("");
  onGroupChange(GROUPS[0].id);
}

function fillConditions(groupId){
  const g = GROUPS.find(x=>x.id===groupId) || GROUPS[0];
  conditionSelect.innerHTML = g.options.map(o => `<option value="${o.id}">${o.name}</option>`).join("");
  condHelp.textContent = g.help || "";
}

function onGroupChange(groupId){
  fillConditions(groupId);
  const g = GROUPS.find(x=>x.id===groupId) || GROUPS[0];
  const isRes = g.type === "residential";
  coeffField.classList.toggle("hidden", !isRes);
  ceilingField.classList.toggle("hidden", !isRes);
  capLabel.textContent = isRes ? "추정 기준" : "1대 기준 공조면적";
  if (isRes) fillCoeffs();
}

groupSelect.addEventListener("change", (e)=> onGroupChange(e.target.value));

function renderBadges(...items){
  badgeBox.innerHTML = items.filter(Boolean).map(x=>`<span class="badge">${x}</span>`).join("");
}

function renderTableResult(groupName, optionName, rawAreaM2, effAreaM2, rec){
  const inputPyRaw = rawAreaM2 / M2_PER_PY;
  const inputPyEff = effAreaM2 / M2_PER_PY;
  const capPy = rec.capM2 / M2_PER_PY;

  outputCard.style.display = "block";
  if (tmaxText){ tmaxText.textContent = (lastTmax3y===null) ? "-" : `${lastTmax3y.toFixed(1)} °C`; }
  renderBadges(sidoSelect.value, sigunguSelect.value, groupName, optionName);

  inputAreaText.textContent = (tempFactor === 1.0)
    ? `${fmt(rawAreaM2)} m² (${fmt(inputPyRaw)} 평)`
    : `${fmt(rawAreaM2)} m² (${fmt(inputPyRaw)} 평) → 보정 ${fmt(effAreaM2)} m² (${fmt(inputPyEff)} 평)`;

  capAreaText.textContent = `${fmt(rec.capM2)} m² (${fmt(capPy)} 평)`;

  if (rec.mode === "table"){
    kwText.innerHTML = `${rec.match.kw} kW <span class="kwSub">(${rec.match.ks_py}평형)</span>`;
    marginText.textContent = `${fmt(rec.capM2 - effAreaM2)} m² (${fmt((rec.capM2 - effAreaM2)/M2_PER_PY)} 평)`;
    methodText?.textContent = tempFactor === 1.0 ? "표 기반(최소 kW 선택)" : `표 기반(보정 × ${tempFactor.toFixed(2)})`;
    extraBox.innerHTML = "";
  } else {
    kwText.innerHTML = `약 ${rec.estKw} kW <span class="kwSub">(≈ ${round1(rec.estKw / rec.match.kw * rec.match.ks_py)}평형 환산)</span>`;
    marginText.textContent = "-";
    methodText?.textContent = tempFactor === 1.0 ? "표 최대 기준 비례 계산" : `표 최대 기준 비례 계산(보정 × ${tempFactor.toFixed(2)})`;
    extraBox.innerHTML = `<div class="info">
      표 최대(58.2kW) 범위를 초과하여 <b>기존 표 비율</b>로 비례 계산했습니다.<br/>
      참고: 58.2kW급으로 분산하면 <b>${rec.estUnits}대</b> 이상이 필요할 수 있어요.
    </div>`;
  }
}

function renderResidentialResult(groupName, optionName, rawAreaM2, effAreaM2, rec){
  const inputPyRaw = rawAreaM2 / M2_PER_PY;
  const inputPyEff = effAreaM2 / M2_PER_PY;

  outputCard.style.display = "block";
  if (tmaxText){ tmaxText.textContent = (lastTmax3y===null) ? "-" : `${lastTmax3y.toFixed(1)} °C`; }
  renderBadges(sidoSelect.value, sigunguSelect.value, groupName, optionName);

  inputAreaText.textContent = (tempFactor === 1.0)
    ? `${fmt(rawAreaM2)} m² (${fmt(inputPyRaw)} 평)`
    : `${fmt(rawAreaM2)} m² (${fmt(inputPyRaw)} 평) → 보정 ${fmt(effAreaM2)} m² (${fmt(inputPyEff)} 평)`;

  kwText.innerHTML = `약 ${rec.estKw} kW <span class="kwSub">(≈ ${round1((rec.estKw*1000)/(110*3.3058))}평형 환산)</span>`;
  capAreaText.textContent = `부하계수 ${rec.coeffWpm2} W/m² × 천장계수 ${rec.ceilingFactor} × 옵션계수 ${rec.optionFactor}`;
  marginText.textContent = "-";
  methodText?.textContent = tempFactor === 1.0 ? "주택 간편 추정(면적×부하계수)" : `주택 간편 추정(보정 × ${tempFactor.toFixed(2)})`;

  extraBox.innerHTML = `<div class="info">
    주택/아파트/빌라 계산은 “간편 추정”입니다. 단열/일사/층/창면적/출입문 등에 따라 조정이 필요할 수 있어요.
  </div>`;
}

document.getElementById("calcBtn").addEventListener("click", async ()=>{
  // 계산 직전: 기상청 보정 자동 반영(선택 시)
  if (useKma?.checked){
    const now = Date.now();
    const key = cacheKeyForKma();
    if (_kmaCache.key === key && (now - _kmaCache.at) < KMA_CACHE_MS){
      setTempFactor(_kmaCache.factor);
      tempText?.textContent = `× ${tempFactor.toFixed(2)}`;
      lastTmax3y = _kmaCache.tmax;
      tempHelp?.textContent = (lastTmax3y===null)
        ? `최근 조회값 재사용(캐시): × ${tempFactor.toFixed(2)}`
        : `최근 조회값 재사용(캐시): 최고 ${lastTmax3y.toFixed(1)}°C · × ${tempFactor.toFixed(2)}`;
    } else {
      await refreshTempFactor();
      _kmaCache = { key, at: Date.now(), tmax: lastTmax3y, factor: tempFactor };
    }
  }

  const rawAreaM2 = toM2(areaInput.value, unitSelect.value);
  if (!rawAreaM2){
    alert("면적을 올바르게 입력해 주세요.");
    return;
  }
  const effAreaM2 = rawAreaM2 * tempFactor;

  const g = GROUPS.find(x => x.id === groupSelect.value);
  const optId = conditionSelect.value;
  const opt = g.options.find(o => o.id === optId);

  if (g.type === "residential"){
    const coeffWpm2 = Number(coeffSelect.value);
    const ceilFactor = Number(ceilingSelect.value);
    const rec = recommendResidential(effAreaM2, coeffWpm2, ceilFactor, optId);
    renderResidentialResult(g.name, opt.name, rawAreaM2, effAreaM2, rec);
  } else {
    const rec = recommendTable(optId, effAreaM2);
    renderTableResult(g.name, opt.name, rawAreaM2, effAreaM2, rec);
  }
});

function openNaverMapSearch(query){
  const q = encodeURIComponent(query);

  // 네이버지도 앱 스킴(검색어 포함) → 실패 시 웹으로 fallback
  const appUrl = `nmap://search?query=${q}&appname=ai_aircon_calculator`;
  const webUrl = `https://map.naver.com/v5/search/${q}`;

  const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  if (!isMobile){
    window.open(webUrl, "_blank");
    return;
  }

  const start = Date.now();
  window.location.href = appUrl;

  setTimeout(() => {
    // 앱이 열리지 않았을 가능성이 높을 때만 웹으로 fallback
    if (Date.now() - start < 1200){
      window.location.href = webUrl;
    }
  }, 700);
}

document.getElementById("naverBtn").addEventListener("click", ()=>{
  const sigungu = (sigunguSelect.value || "").trim();
  const sido = (sidoSelect.value || "").trim();
  const base = sigungu || sido || "제주";
  openNaverMapSearch(`${base} 에어컨`);
});
// init
fillSido();
fillGroups();
useKma?.addEventListener("change", refreshTempFactor);

</script>
</body>
</html>
